<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TecnoApps - Gesti√≥n de Servicios</title>
  <!-- Bootstrap -->
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/font-awesome.min.css">
  <link rel="stylesheet" href="../css/animate.css">
  <link href="../css/animate.min.css" rel="stylesheet">
  <link href="../css/estilo.css" rel="stylesheet"/>
  <link href="../css/style.css" rel="stylesheet"/>
  <link href="../css/gestion-servicios.css" rel="stylesheet"/>
  <!-- FontAwesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <!-- HEADER -->
  <header id="header">
      <nav class="navbar navbar-default navbar-static-top" role="banner">
          <div class="container">
              <div class="navbar-header">
                  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar" aria-expanded="false">
                      <span class="sr-only">Toggle navigation</span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                      <span class="icon-bar"></span>
                  </button>
                  <!-- Logo y nombre -->
                  <a class="navbar-brand" href="../pages/index.html">
                      <img src="../img/logo_transparente.png" alt="Logo" height="100px">
                      <span class="brand-text">TecnoApps</span>
                  </a>
              </div>
              <div class="collapse navbar-collapse" id="main-navbar">
                  <div class="menu">
                      <ul class="nav nav-tabs navbar-left" role="tablist">
                          <li><a href="../pages/servicios.html">Servicios</a></li>
                          <li><a href="../pages/GestionServicios.html">Gesti√≥n de servicios</a></li>
                          <li><a href="../pages/contact.html">Cont√°ctanos</a></li>
                          <li role="presentation"><a href="#" onclick="cerrarSesion()">Cerrar sesi√≥n</a></li>
                      </ul>
                  </div>
              </div>
          </div>
      </nav>
  </header>
  <main class="container">
      <h2>Gesti√≥n de servicios</h2>
      <button class="btn" id="btnNuevoServicio">‚ûï Agregar servicio</button>

      <form class="form-stacked" id="formServicio">
          <div class="form-group">
              <label for="nombre">Nombre:</label>
              <input type="text" id="nombre" placeholder="Nombre del servicio" required>
          </div>
          <div class="form-group imagen-group">
              <label for="imagen">Imagen:</label>
              <div class="imagen-inputs">
                  <div class="image-box" id="preview">Sin imagen</div>
                  <div>
                      <input type="file" id="imagen" accept="image/*" hidden>
                      <button type="button" id="btn-imagen" onclick="document.getElementById('imagen').click()">Buscar Imagen</button>
                  </div>
              </div>
          </div>
          <div class="form-group">
              <label for="precio">Precio:</label>
              <input type="number" id="precio" placeholder="Precio del servicio" required min="0">
          </div>
          <div class="form-group">
              <label for="cantidad">Cantidad:</label>
              <input type="number" id="cantidad" placeholder="Cantidad disponible" required min="0">
          </div>
          <div class="form-group">
              <label for="descripcion">Descripci√≥n:</label>
              <textarea id="descripcion" placeholder="Descripci√≥n del servicio" required></textarea>
          </div>
          <div class="form-group">
              <label for="promocion">Promoci√≥n:</label>
              <select id="promocion" required>
                  <option value="">Seleccionar</option>
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
              </select>
          </div>
          <div class="form-buttons">
              <button class="btn" type="submit" id="btnGuardar">Guardar servicio</button>
              <button class="btn" type="button" id="btnCancelar">Cancelar</button>
          </div>
      </form>

      <!-- TABLA con scroll -->
      <h2>Listado de Servicios</h2>
      <div class="table-container">
          <table class="services-table">
              <thead>
                  <tr>
                      <th>ID</th>
                      <th>Nombre</th>
                      <th>Imagen</th>
                      <th>Precio</th>
                      <th>Cantidad</th>
                      <th>Descripci√≥n</th>
                      <th>Promoci√≥n</th>
                      <th>Acciones</th>
                  </tr>
              </thead>
              <tbody id="tablaServicios">
              </tbody>
          </table>
      </div>
  </main>
  <footer>
      <div class="footer-container">
          <div class="col">
              <img src="../img/logo_transparente.png" alt="TecnoApps" class="footer-logo">
              <h3>TecnoApps</h3>
              <p class="desc">Empresa de desarrollo de aplicaciones m√≥viles y web, dise√±o de p√°ginas web y tiendas online en Colombia.</p>
          </div>
          <div class="col">
              <h3>Servicios</h3>
              <ul>
                  <li><a href="#">Desarrollo Web</a></li>
                  <li><a href="#">Soporte en la nube</a></li>
                  <li><a href="#">Ciberseguridad</a></li>
                  <li><a href="#">Licencias de software</a></li>
                  <li><a href="#">Consultor√≠a IT</a></li>
                  <li><a href="#">An√°lisis de datos</a></li>
                  <li><a href="#">Optimizaci√≥n SEO</a></li>
                  <li><a href="#">Soporte t√©cnico</a></li>
                  <li><a href="#">Redes y conectividad</a></li>
                  <li><a href="#">Gesti√≥n de infraestructura</a></li>
              </ul>
          </div>
          <div class="col">
              <h3>Contacto</h3>
              <p class="desc">3173968717</p>
              <p class="desc">nmogollon@poligran.edu.co</p>
              <div class="social-icons">
                  <a href="#"><i class="fab fa-whatsapp"></i></a>
                  <a href="#"><i class="fab fa-facebook"></i></a>
                  <a href="#"><i class="fab fa-instagram"></i></a>
                  <a href="#"><i class="fab fa-twitter"></i></a>
                  <a href="#"><i class="fab fa-linkedin"></i></a>
              </div>
          </div>
      </div>
      <p class="copy">Copyright ¬©2025 TecnoApps | Todos los derechos reservados</p>
  </footer>

  <!-- JavaScript -->
  <script>
      const API_URL = 'https://worthy-intuition-production.up.railway.app';
      let servicios = [];
      let editingId = null;

      // Inicializar
      document.addEventListener('DOMContentLoaded', function() {
          cargarServicios();
          configurarEventos();
      });

      function configurarEventos() {
          // Formulario
          document.getElementById('formServicio').addEventListener('submit', guardarServicio);
          document.getElementById('btnNuevoServicio').addEventListener('click', nuevoServicio);
          document.getElementById('btnCancelar').addEventListener('click', cancelarEdicion);
          
          // Preview de imagen
          document.getElementById('imagen').addEventListener('change', function (event) {
              const file = event.target.files[0];
              const preview = document.getElementById('preview');
              if (file) {
                  const reader = new FileReader();
                  reader.onload = function (e) {
                      preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100px; max-height: 100px;">`;
                  }
                  reader.readAsDataURL(file);
              } else {
                  preview.innerHTML = 'Sin imagen';
              }
          });
      }

      // Cargar servicios desde la API
      async function cargarServicios() {
          try {
              console.log('üîó Cargando servicios desde:', `${API_URL}/api/servicios`);
              
              const response = await fetch(`${API_URL}/api/servicios`);
              
              if (!response.ok) {
                  throw new Error(`Error ${response.status}: ${response.statusText}`);
              }
              
              servicios = await response.json();
              console.log('‚úÖ Servicios cargados:', servicios);
              renderizarTabla();
              
          } catch (error) {
              console.error('‚ùå Error al cargar servicios:', error);
              alert('Error al cargar servicios. Aseg√∫rate de que el backend est√© ejecut√°ndose.');
          }
      }

      // Renderizar tabla
      function renderizarTabla() {
          const tbody = document.getElementById('tablaServicios');
          tbody.innerHTML = '';

          if (servicios.length === 0) {
              tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay servicios registrados</td></tr>';
              return;
          }

          servicios.forEach(servicio => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                  <td>${servicio.id}</td>
                  <td>${servicio.nombre}</td>
                  <td>${servicio.imagen ? `<img src="${API_URL}${servicio.imagen}" alt="${servicio.nombre}" class="tabla-img" style="max-width: 50px; max-height: 50px; border-radius: 4px;">` : 'Sin imagen'}</td>
                  <td>$${servicio.precio ? servicio.precio.toLocaleString() : '0'}</td>
                  <td>${servicio.cantidad || '0'}</td>
                  <td>${servicio.descripcion || 'Sin descripci√≥n'}</td>
                  <td>${servicio.promocion ? 'S√≠' : 'No'}</td>
                  <td>
                      <button class="btn editar" onclick="editarServicio(${servicio.id})" style="background: #ffc107; color: black; margin: 2px;">Editar</button>
                      <button class="btn eliminar" onclick="eliminarServicio(${servicio.id})" style="background: #dc3545; margin: 2px;">Eliminar</button>
                  </td>
              `;
              tbody.appendChild(tr);
          });
      }

      function nuevoServicio() {
          editingId = null;
          limpiarFormulario();
          document.getElementById('nombre').focus();
      }

      async function guardarServicio(e) {
          e.preventDefault();
          
          const formData = new FormData();
          formData.append('nombre', document.getElementById('nombre').value);
          formData.append('precio', document.getElementById('precio').value);
          formData.append('cantidad', document.getElementById('cantidad').value);
          formData.append('descripcion', document.getElementById('descripcion').value);
          formData.append('promocion', document.getElementById('promocion').value);
          
          const imagenInput = document.getElementById('imagen');
          if (imagenInput.files[0]) {
              formData.append('imagen', imagenInput.files[0]);
              console.log('üì∏ Imagen incluida:', imagenInput.files[0].name);
          } else {
              console.log('üì∏ Sin imagen seleccionada');
          }

          console.log('üÜï Enviando servicio con FormData...');

          try {
              let response;
              if (editingId) {
                  // Actualizar
                  console.log(`‚úèÔ∏è Actualizando servicio ID: ${editingId}`);
                  response = await fetch(`${API_URL}/api/servicios/${editingId}`, {
                      method: 'PUT',
                      body: formData  
                  });
              } else {
                  // Crear
                  console.log('üÜï Creando nuevo servicio');
                  response = await fetch(`${API_URL}/api/servicios`, {
                      method: 'POST',
                      body: formData  
                  });
              }

              if (response.ok) {
                  const servicioGuardado = await response.json();
                  console.log('‚úÖ Servicio guardado exitosamente:', servicioGuardado);
                  alert(`Servicio ${editingId ? 'actualizado' : 'creado'} correctamente`);
                  limpiarFormulario();
                  await cargarServicios();
              } else {
                  const errorText = await response.text();
                  console.error('‚ùå Error del servidor:', errorText);
                  throw new Error(`Error del servidor: ${errorText}`);
              }
          } catch (error) {
              console.error('‚ùå Error al guardar servicio:', error);
              alert('Error al guardar servicio: ' + error.message);
          }
      }

      async function editarServicio(id) {
          const servicio = servicios.find(s => s.id == id || s.id === parseInt(id));
          if (!servicio) {
              console.error('Servicio no encontrado:', id);
              alert('Servicio no encontrado');
              return;
          }

          editingId = servicio.id;
          
          console.log('‚úèÔ∏è Editando servicio:', servicio);
          
          // Llenar formulario
          document.getElementById('nombre').value = servicio.nombre || '';
          document.getElementById('precio').value = servicio.precio || '';
          document.getElementById('cantidad').value = servicio.cantidad || '';
          document.getElementById('descripcion').value = servicio.descripcion || '';
          document.getElementById('promocion').value = servicio.promocion ? 'true' : 'false';
          
          // Mostrar imagen actual si existe
          const preview = document.getElementById('preview');
          if (servicio.imagen) {
              preview.innerHTML = `<img src="${API_URL}${servicio.imagen}" alt="Preview" style="max-width: 100px; max-height: 100px;">`;
              console.log('üñºÔ∏è Imagen cargada:', servicio.imagen);
          } else {
              preview.innerHTML = 'Sin imagen';
          }
          
          // Cambiar texto del bot√≥n
          document.getElementById('btnGuardar').textContent = 'Actualizar servicio';
          
          // Scroll al formulario
          document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
      }

      // Eliminar servicio
      async function eliminarServicio(id) {
          if (!confirm('¬øEst√°s seguro de que quieres eliminar este servicio?')) {
              return;
          }

          try {
              console.log('üóëÔ∏è Eliminando servicio:', id);
              
              const response = await fetch(`${API_URL}/api/servicios/${id}`, {
                  method: 'DELETE'
              });

              if (response.ok) {
                  alert('Servicio eliminado correctamente');
                  await cargarServicios(); // Recargar la lista
              } else {
                  const errorText = await response.text();
                  throw new Error(`Error al eliminar: ${errorText}`);
              }
          } catch (error) {
              console.error('‚ùå Error al eliminar servicio:', error);
              alert('Error al eliminar servicio: ' + error.message);
          }
      }

      function limpiarFormulario() {
          document.getElementById('formServicio').reset();
          document.getElementById('preview').innerHTML = 'Sin imagen';
          document.getElementById('btnGuardar').textContent = 'Guardar servicio';
          editingId = null;
      }

      function cancelarEdicion() {
          limpiarFormulario();
      }

      function cerrarSesion() {
          localStorage.removeItem("usuarioLogueado");
          window.location.href = "login.html";
      }

      async function probarConexion() {
          try {
              const response = await fetch(`${API_URL}/health`);
              const data = await response.json();
              console.log('‚úÖ Conexi√≥n exitosa:', data);
              return true;
          } catch (error) {
              console.error('‚ùå Error de conexi√≥n:', error);
              return false;
          }
      }

      probarConexion();
  </script>
</body>
</html>